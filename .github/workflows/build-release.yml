name: Build and Release

on:
  push:
    branches:
      - main

# Prevent concurrent builds on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set version number
        run: |
          VERSION_BASE=$(grep -o '__version_base__\s*=\s*"[^"]*"' src/version.py | cut -d'"' -f2)
          FULL_VERSION="${VERSION_BASE}.${{ github.run_number }}"
          echo "Building version: $FULL_VERSION"
          sed -i '' "s/__version__ = \".*\"/__version__ = \"$FULL_VERSION\"/" src/version.py
          cat src/version.py

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build macOS app
        run: python build.py macos

      - name: Create DMG
        run: |
          hdiutil create -volname "AlbumStudio" -srcfolder dist/AlbumStudio.app -ov -format UDZO dist/AlbumStudio-macOS.dmg

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: AlbumStudio-macOS
          path: dist/AlbumStudio-macOS.dmg
          retention-days: 5

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set version number
        shell: pwsh
        run: |
          $content = Get-Content src/version.py -Raw
          $versionBase = [regex]::Match($content, '__version_base__\s*=\s*"([^"]*)"').Groups[1].Value
          $fullVersion = "$versionBase.${{ github.run_number }}"
          Write-Host "Building version: $fullVersion"
          $content = $content -replace '__version__ = "[^"]*"', "__version__ = `"$fullVersion`""
          Set-Content src/version.py $content
          Get-Content src/version.py

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller

      - name: Build Windows app
        run: python build.py windows

      - name: Create ZIP archive
        run: |
          Compress-Archive -Path dist/AlbumStudio/* -DestinationPath dist/AlbumStudio-Windows.zip

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: AlbumStudio-Windows
          path: dist/AlbumStudio-Windows.zip
          retention-days: 5

  release:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: AlbumStudio-macOS
          path: artifacts/

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: AlbumStudio-Windows
          path: artifacts/

      - name: Generate version
        id: version
        run: |
          VERSION_BASE=$(grep -o '__version_base__\s*=\s*"[^"]*"' src/version.py | cut -d'"' -f2)
          FULL_VERSION="${VERSION_BASE}.${{ github.run_number }}"
          echo "version=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "Release version: $FULL_VERSION"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Album Studio v${{ steps.version.outputs.version }}
          body: |
            ## Album Studio v${{ steps.version.outputs.version }}

            **Commit:** ${{ github.sha }}
            **Message:** ${{ github.event.head_commit.message }}

            ### Downloads
            - **macOS:** `AlbumStudio-macOS.dmg` - Double-click to mount, drag to Applications
            - **Windows:** `AlbumStudio-Windows.zip` - Extract and run `AlbumStudio.exe`
          files: |
            artifacts/AlbumStudio-macOS.dmg
            artifacts/AlbumStudio-Windows.zip
          draft: false
          prerelease: false
